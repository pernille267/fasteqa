% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/RcppExports.R
\name{sim_eqa_data2}
\alias{sim_eqa_data2}
\title{Simulation of External Quality Assessment (EQA) Data}
\usage{
sim_eqa_data2(
  parameters = NULL,
  type = 0L,
  AR = FALSE,
  include_parameters = FALSE
)
}
\arguments{
\item{parameters}{A \code{list} of parameters and their value. These values
       are used to simulate the EQA data. Optional parameters that you may
       include into the list are:
\itemize{
  \item \code{n: } The number of samples. Defaults to 25.
  \item \code{R: } The number of replicates on each sample. Must be >= 1. Defaults to 3.
  \item \code{cvx: } The base repeatability coefficient of variation for IVD-MD
                     \code{MP_B}. Defaults to 0.01.
  \item \code{cvy: } The base repeatability coefficient of variation for IVD-MD
                     \code{MP_A}. Defaults to 0.01.
  \item \code{cil: } The lower bound of the concentration interval. Defaults to 2.0.
  \item \code{ciu: } The upper bound of the concentration interval. Must be > \code{cil}. Defaults to 10.0.
  \item \code{dist: } The distribution to simulate latent variables \eqn{\tau_i} from.
                      Possible choices include
                      \code{"unif"} (uniform distribution, default),
                      \code{"norm"} (normal distribution),
                      \code{"lst"} (location-scale student t-distribution),
                      \code{"lnorm"} (log-normal distribution).
  \item \code{df_tau: } The degrees of freedom for the \code{lst}
                        distribution if \code{dist = "lst"}.
                        Defaults to 5.0 if not otherwise specified. Must be > 0.
  \item \code{eta: } The heteroscedasticity factor \eqn{\eta}. Controls how strongly SD depends on concentration. See Details. Defaults to 0.
  \item \code{eta0: } The base heteroscedasticity factor \eqn{\eta_0}. See Details. Defaults to 1.0.
  \item \code{qpos: } Position of systematic differences in non-selectivity.
                      \code{0} signify lower concentration interval and
                      \code{1} signify upper. Only used if \code{qran} is specified and \code{prop} is not.
  \item \code{qran: } Interquantile range (proportion of total range, 0 to 1) where systematic differences in
                      non-selectivity should have its effect. E.g., 0.3 means the lower or upper 30% of the range. Only used if \code{prop} is not specified.
  \item \code{prop: } Average proportion (0 to 1) of clinical samples affected by
                      random differences in non-selectivity. If specified, overrides \code{qpos}/\code{qran}. Defaults to 0.
  \item \code{mmax: } The maximum relocation magnitude multiplier,
                      \eqn{m_{\max}}. This number is a multiplier of the
                      *base* standard deviation \code{sqrt(base_sd_x^2 + base_sd_y^2)}. Only effective
                      if \code{prop > 0} or \code{qran > 0}. Defaults to 0.
  \item \code{b0: } For systematic linear bias between IVD-MDs (intercept). Defaults to 0.
  \item \code{b1: } For systematic linear bias between IVD-MDs (slope). Defaults to 1.
  \item \code{c0: } Intercept for linear transformation from latent \eqn{\xi_i} to \eqn{\tau_i}. Defaults to 0. (Often ignored).
  \item \code{c1: } Slope for linear transformation from latent \eqn{\xi_i} to \eqn{\tau_i}. Defaults to 1. (Often ignored).
  \item \code{error_dist: } The distribution to simulate measurement error
                            components (\eqn{h_{ir}, v_{ir}}) from. Possible choices include \code{"norm"}
                            (normal distribution, default) and
                            \code{"lt"} (location-scale student t-distribution).
  \item \code{dfx: } The degrees of freedom for the measurement error
                     components in IVD-MD B if \code{error_dist = "lt"}.
                     Defaults to 5.0 if not otherwise specified. Must be > 0.
  \item \code{dfy: } The degrees of freedom for the measurement error
                     components in IVD-MD A if \code{error_dist = "lt"}.
                     Defaults to 5.0 if not otherwise specified. Must be > 0.
  \item \code{md_method: } Method for simulating missing data. Possible
                           choices include \code{"none"} (no missing data, default),
                           \code{"mar"} (missing at random),
                           \code{"mnar"} (missing not at random based on value vs threshold),
                           \code{"mnar0"} (missing not at random if value < threshold, treats negative values as missing if threshold <= 0),
                           \code{"marmnar"} (combination of MAR and MNAR),
                           \code{"marmnar0"} (combination of MAR and MNAR0).
  \item \code{mar_prob: } The probability (value between 0 and 1) of having
                          a measurement missing at random. Only relevant if
                          \code{md_method} includes \code{"mar"}. Defaults to 0.05 if needed.
  \item \code{mnar_threshold: } The threshold (\code{double}) below which
                                a measurement is considered missing for MNAR.
                                Only relevant if \code{md_method} includes \code{"mnar"} or \code{"mnar0"}.
                                Defaults to \code{cil} if \code{md_method = "mnar"} or \code{"marmnar"}.
                                Defaults to 0.0 if \code{md_method = "mnar0"} or \code{"marmnar0"}.
  \item \code{g: } A custom R function defining the relationship \eqn{g(\tau_i) = E[y_{ir} | \tau_i]}.
                   It should take a single numeric value (\eqn{\tau_i}) and return a single numeric value.
                   Overrides \code{type}, \code{b0}, \code{b1}, and non-selectivity parameters (\code{prop}, \code{qpos}, \code{qran}, \code{mmax}).
                   Using this can be slower than built-in types.
  \item \code{obs_tau: } A \code{numeric} vector of pre-defined \eqn{\tau_i} values.
                         If specified, \code{n} becomes \code{length(obs_tau)}, and \code{dist}, \code{cil}, \code{ciu}, \code{df_tau} are ignored.
}}

\item{type}{A \code{integer} specifying built-in functions for \eqn{g(\tau_i)}. Ignored if \code{g} is provided in \code{parameters}.
\itemize{
   \item \code{type = 0: } Linear relationship \eqn{g(\tau_i) = \beta_0 + \beta_1 \tau_i + \mathrm{nonselectivity}}. (Default)
   \item \code{type = 1: } Non-linear \eqn{g(\tau_i) = \tau_i + 0.90 \cdot \sin(0.40 \cdot \tau_i^{1.06})}
   \item \code{type = 2: } Non-linear \eqn{g(\tau_i) = \tau_i + 0.05 \cdot \exp(0.16 \cdot \tau_i^{1.35})}
   \item \code{type = 3: } Non-linear \eqn{g(\tau_i) = \tau_i - \exp[-0.125 \cdot (\tau_i - 1.50)^2]}
}}

\item{AR}{A \code{logical} value. If \code{TRUE}, data includes all replicates. If \code{FALSE}, the mean of replicates (MOR) for each sample is returned (handling NAs appropriately).}

\item{include_parameters}{A \code{logical} value. If \code{TRUE}, the parameters used in the simulation are returned as a list element named \code{parameters}. Defaults to \code{FALSE}.}
}
\value{
A \code{list}.
If \code{include_parameters = FALSE}:
Contains elements \code{SampleID}, \code{MP_A}, \code{MP_B}. If \code{AR = TRUE}, also includes \code{ReplicateID}.
If \code{include_parameters = TRUE}:
A list containing two elements:
\itemize{
  \item \code{simulated_data:} The list described above.
  \item \code{parameters:} A list of the parameter values actually used in the simulation.
}
}
\description{
Simulates method comparison data based on specified parameters, allowing for various complexities like non-linear relationships, heteroscedasticity, non-selectivity, and missing data.
}
\details{
The simulation generates measurement pairs \eqn{(x_{ir}, y_{ir})} for sample \eqn{i} and replicate \eqn{r}, based on the model:
\deqn{x_{ir} = \tau_i + h_{ir}}
\deqn{y_{ir} = g(\tau_i) + v_{ir}}
where \eqn{\tau_i} represents the true (latent) value for sample \eqn{i} for method B (often assumed \eqn{\tau_i = c_0 + c_1 \xi_i}), \eqn{g(\tau_i)} is the expected value for method A given \eqn{\tau_i}, and \eqn{h_{ir}} and \eqn{v_{ir}} are measurement errors.

\strong{True Values (\eqn{\tau_i}):} Generated based on \code{dist}, \code{cil}, \code{ciu}, unless \code{obs_tau} is provided.

\strong{Relationship (\eqn{g}):} Defined by \code{type} or a custom R function \code{g}. For \code{type = 0}, it incorporates linear bias (\code{b0}, \code{b1}) and potential non-selectivity effects (\code{prop}, \code{qpos}, \code{qran}, \code{mmax}). Non-selectivity effects add an offset for specific samples.

\strong{Measurement Errors (\eqn{h_{ir}, v_{ir}}):} Generated based on \code{error_dist} (\code{"norm"} or \code{"lt"}) with standard deviations derived from \code{cvx}, \code{cvy} and potentially modified by heteroscedasticity parameters \code{eta} and \code{eta0}. The model used is \eqn{SD(\tau_i) = \mathrm{base\_sd} \times (\eta_0 + (\tau_i / \mathrm{average\_tau})^\eta)}, where \eqn{\mathrm{base\_sd}} is \code{average_tau * cv}, and \code{average_tau} is \code{0.5*(cil+ciu)}. If \code{eta = 0} and \code{eta0 = 1}, this results in constant CV.

\strong{Non-Selectivity:} If \code{prop > 0}, a random proportion of samples have their \eqn{g(\tau_i)} value shifted by a random amount up to \code{mmax} times the base combined SD. If \code{qran > 0} (and \code{prop = 0}), samples in the specified quantile range (\code{qpos}, \code{qran}) have their \eqn{g(\tau_i)} shifted systematically based on their position within that range, up to \code{mmax}.

\strong{Missing Data:} Can be introduced using \code{md_method}. \code{"mar"} introduces NAs randomly. \code{"mnar"} introduces NAs if the simulated value falls below \code{mnar_threshold}. \code{"mnar0"} is similar to \code{"mnar"} but defaults the threshold to 0 and handles potentially negative simulated values as missing below this threshold.

\strong{Negative Values:} If \code{md_method} is not \code{"mnar0"}, any simulated negative measurement values \eqn{x_{ir}} or \eqn{y_{ir}} are clamped at 0.0. If \code{md_method = "mnar0"}, values below the \code{mnar_threshold} (defaulting to 0) are set to \code{NA_REAL}. Choose parameters (\code{cil}, \code{cvx}, \code{cvy}, \code{mmax}) carefully to avoid excessive negative values if they are physically implausible.

\strong{Output Conversion:} The returned list can be efficiently converted to other formats using \code{as.data.frame()}, \code{as.data.table::data.table()}, \code{tibble::as_tibble()}, or \code{data.table::setDT()}.
}
\examples{
# Load package (assuming it's built and loaded)
# library(yourPackageName) # Replace with your package name

# Default simulation (n=25, R=3, linear, const CV)
default_sim <- sim_eqa_data()
print(head(as.data.frame(default_sim)))

# Simulation with heteroscedasticity and t-distributed errors
params_hetero_t <- list(n = 50, R = 2, cvx = 0.02, cvy = 0.03,
                        cil = 10, ciu = 100, eta = 0.5, eta0 = 0.5,
                        error_dist = "lt", dfx = 4, dfy = 6)
sim_hetero_t <- sim_eqa_data(params_hetero_t, AR = TRUE)
# plot(sim_hetero_t$MP_B, sim_hetero_t$MP_A) # Requires conversion first

# Simulation with random non-selectivity (type 0) and MAR missing data
params_nonselect_mar <- list(n = 40, R = 4, cvx = 0.01, cvy = 0.01,
                             cil = 5, ciu = 50, prop = 0.15, mmax = 4,
                             md_method = "mar", mar_prob = 0.1)
sim_nonselect_mar <- sim_eqa_data(params_nonselect_mar, type = 0, AR = TRUE,
                                  include_parameters = TRUE)
print(head(as.data.frame(sim_nonselect_mar$simulated_data)))
print(sim_nonselect_mar$parameters)

# Simulation with systematic non-selectivity (upper range) and MNAR missing data
params_syst_nonselect_mnar <- list(n = 30, R = 2, cvx = 0.015, cvy = 0.015,
                                   cil = 2, ciu = 20, qpos = 1, qran = 0.25, mmax = 5,
                                   md_method = "mnar") # threshold defaults to cil=2
sim_syst_nonselect_mnar <- sim_eqa_data(params_syst_nonselect_mnar, type = 0, AR = FALSE)
print(head(as.data.frame(sim_syst_nonselect_mnar)))

# Simulation using a custom non-linear function g and observed tau
my_g <- function(tau) { tau + 0.1 * tau^2 }
true_taus <- c(1, 3, 5, 7, 9, 11, 13, 15)
params_custom_g <- list(R = 5, cvx = 0.005, cvy = 0.008, obs_tau = true_taus, g = my_g)
sim_custom_g <- sim_eqa_data(params_custom_g, AR = TRUE)
print(head(as.data.frame(sim_custom_g)))

}
